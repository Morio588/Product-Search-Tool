<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¢å“æŸ¥æ‰¾å·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* çœç•¥ï¼šä¿æŒä½ åŸæœ¬çš„ CSS å®Œæ•´å…§å®¹ä¸å‹• */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ç”¢å“æŸ¥æ‰¾å·¥å…·</h1>
      <div class="divider"></div>
      <p class="subtitle">åƒ…é™ iStore å…§éƒ¨å“¡å·¥ä½¿ç”¨</p>
      
      <div class="nav-menu">
        <button class="nav-btn active" onclick="showPage('search')">ç”¢å“æœå°‹</button>
        <button class="nav-btn" onclick="showPage('education')">æ•™è‚²åƒ¹</button>
        <button class="nav-btn" onclick="showPage('care')">CARE ä¿éšª</button>
      </div>
    </div>

    <!-- ç”¢å“æœå°‹é é¢ -->
    <div id="searchPage" class="page active">
      <div class="search-section">
        <div class="search-container">
          <div class="search-row">
            <div class="search-input-wrapper">
              <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input type="text" id="searchInput" placeholder="è¼¸å…¥ç”¢å“åç¨±ã€ä»£ç¢¼æˆ–åˆ†é¡é—œéµå­—é€²è¡Œæœå°‹...">
            </div>
            
            <select id="categoryFilter" class="filter-select">
              <option value="">æ‰€æœ‰å¤§åˆ†é¡</option>
            </select>
            
            <select id="subcategoryFilter" class="filter-select">
              <option value="">æ‰€æœ‰ä¸­åˆ†é¡</option>
            </select>
            
            <button id="clearFilters" class="clear-filters">æ¸…é™¤ç¯©é¸</button>
          </div>
          
          <div id="filterInfo" class="filter-info"></div>
          
          <div class="quick-filters">
            <div class="quick-filter-label">å¿«é€Ÿç¯©é¸ï¼š</div>
            <button class="quick-filter-btn" onclick="quickFilter('CPU')">CPU</button>
            <button class="quick-filter-btn" onclick="quickFilter('iPad')">iPad</button>
            <button class="quick-filter-btn" onclick="quickFilter('iPhone')">iPhone</button>
            <button class="quick-filter-btn" onclick="quickFilter('Apple Watch')">Apple Watch</button>
          </div>

          <!-- ğŸ”¹ æ–°å¢ï¼šä¸­åˆ†é¡å¿«é€Ÿç¯©é¸ -->
          <div id="subQuickFilters" class="quick-filters" style="display:none;">
            <div class="quick-filter-label">ä¸­åˆ†é¡ï¼š</div>
          </div>
        </div>
      </div>

      <div id="errorInfo" class="error" style="display: none;"></div>

      <div class="table-section">
        <div class="table-container">
          <table id="resultTable">
            <thead>
              <tr>
                <th>å‹è™Ÿ</th>
                <th>Code</th>
                <th>ç”¢å“åç¨±</th>
                <th>å¤§åˆ†é¡</th>
                <th>ä¸­åˆ†é¡</th>
                <th>å°åˆ†é¡</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="loading">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ•™è‚²åƒ¹é é¢ -->
    <div id="educationPage" class="page content-page">
      <div class="content-wrapper">
        <h2 class="page-title">æ•™è‚²åƒ¹æ ¼è³‡è¨Š</h2>
        <!-- ä½ çš„åŸå§‹å…§å®¹ä¿æŒä¸è®Š -->
      </div>
    </div>

    <!-- CARE ä¿éšªé é¢ -->
    <div id="carePage" class="page content-page">
      <div class="content-wrapper">
        <h2 class="page-title">CARE ä¿éšªè³‡è¨Š</h2>
        <!-- ä½ çš„åŸå§‹å…§å®¹ä¿æŒä¸è®Š -->
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>Created by Morio Â© 2025</p>
  </footer>

  <script>
    let data = [];
    let originalData = [];
    let columnMapping = {};
    let allCategories = new Set();
    let allSubcategories = new Set();
    let activeQuickFilter = null;

    // âœ… æ–°å¢ï¼šä¸­åˆ†é¡æŒ‰éˆ•å€
    const subQuickFilters = document.getElementById('subQuickFilters');

    // é é¢åˆ‡æ›åŠŸèƒ½ï¼ˆä¸è®Šï¼‰
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`${pageName}Page`).classList.add('active');
      document.querySelector(`.nav-btn[onclick="showPage('${pageName}')"]`).classList.add('active');
    }

    // åŸæœ¬ initializeFilters()ã€updateSubcategoryOptions()ã€applyFilters() ç­‰å‡½å¼ä¿æŒä¸è®Š

    // âœ… ä¿®æ”¹ quickFilterï¼šæ”¯æ´å‹•æ…‹ç”Ÿæˆä¸­åˆ†é¡æŒ‰éˆ•
    function quickFilter(category) {
      const categorySelect = document.getElementById('categoryFilter');
      const subcategorySelect = document.getElementById('subcategoryFilter');
      const buttons = document.querySelectorAll('.quick-filter-btn');

      buttons.forEach(btn => btn.classList.remove('active'));

      // è‹¥é‡è¤‡é»æ“ŠåŒä¸€å€‹å¤§åˆ†é¡ => å–æ¶ˆé¸æ“‡ä¸¦éš±è—ä¸­åˆ†é¡
      if (activeQuickFilter === category) {
        activeQuickFilter = null;
        categorySelect.value = '';
        subcategorySelect.value = '';
        subQuickFilters.style.display = 'none';
        updateSubcategoryOptions('');
        applyFilters();
        return;
      }

      // æ–°é¸æ“‡çš„å¤§åˆ†é¡
      activeQuickFilter = category;
      categorySelect.value = category;
      subcategorySelect.value = '';
      event.target.classList.add('active');

      // æ‰¾å‡ºå°æ‡‰ä¸­åˆ†é¡
      const relevantSubcategories = new Set();
      originalData.forEach(row => {
        const cat = row[columnMapping['å¤§åˆ†é¡']];
        const sub = row[columnMapping['ä¸­åˆ†é¡']];
        if (cat === category && sub && sub.trim()) {
          relevantSubcategories.add(sub.trim());
        }
      });

      // ç”Ÿæˆä¸­åˆ†é¡æŒ‰éˆ•
      subQuickFilters.innerHTML = '<div class="quick-filter-label">ä¸­åˆ†é¡ï¼š</div>';
      Array.from(relevantSubcategories).sort().forEach(sub => {
        const btn = document.createElement('button');
        btn.className = 'quick-filter-btn';
        btn.textContent = sub;
        btn.onclick = () => {
          subcategorySelect.value = sub;
          applyFilters();
          subQuickFilters.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
        subQuickFilters.appendChild(btn);
      });

      subQuickFilters.style.display = 'flex';
      updateSubcategoryOptions(category);
      applyFilters();
    }

    // âœ… ä¿®æ”¹ï¼šæ¸…é™¤ç¯©é¸æ™‚é—œé–‰ä¸­åˆ†é¡æŒ‰éˆ•å€
    function clearAllFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('subcategoryFilter').value = '';
      activeQuickFilter = null;
      document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
      subQuickFilters.style.display = 'none';
      updateSubcategoryOptions('');
      renderTable(originalData);
      updateFilterInfo();
    }

    // å…¶é¤˜ parseCSVã€renderTableã€loadDefaultCSV ç­‰ä¿æŒåŸæ¨£
    // ...
    async function loadDefaultCSV() {
      try {
        const response = await fetch("data.csv");
        const text = await response.text();
        originalData = await parseCSVWithPapa(text);
        const headers = Object.keys(originalData[0]);
        createColumnMapping(headers);
        renderTable(originalData);
        initializeFilters();
      } catch (error) {
        showError('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + error.message);
      }
    }

    loadDefaultCSV();
  </script>
</body>
</html>
