<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>產品查找工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* 省略：保持你原本的 CSS 完整內容不動 */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>產品查找工具</h1>
      <div class="divider"></div>
      <p class="subtitle">僅限 iStore 內部員工使用</p>
      
      <div class="nav-menu">
        <button class="nav-btn active" onclick="showPage('search')">產品搜尋</button>
        <button class="nav-btn" onclick="showPage('education')">教育價</button>
        <button class="nav-btn" onclick="showPage('care')">CARE 保險</button>
      </div>
    </div>

    <!-- 產品搜尋頁面 -->
    <div id="searchPage" class="page active">
      <div class="search-section">
        <div class="search-container">
          <div class="search-row">
            <div class="search-input-wrapper">
              <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input type="text" id="searchInput" placeholder="輸入產品名稱、代碼或分類關鍵字進行搜尋...">
            </div>
            
            <select id="categoryFilter" class="filter-select">
              <option value="">所有大分類</option>
            </select>
            
            <select id="subcategoryFilter" class="filter-select">
              <option value="">所有中分類</option>
            </select>
            
            <button id="clearFilters" class="clear-filters">清除篩選</button>
          </div>
          
          <div id="filterInfo" class="filter-info"></div>
          
          <div class="quick-filters">
            <div class="quick-filter-label">快速篩選：</div>
            <button class="quick-filter-btn" onclick="quickFilter('CPU')">CPU</button>
            <button class="quick-filter-btn" onclick="quickFilter('iPad')">iPad</button>
            <button class="quick-filter-btn" onclick="quickFilter('iPhone')">iPhone</button>
            <button class="quick-filter-btn" onclick="quickFilter('Apple Watch')">Apple Watch</button>
          </div>

          <!-- 🔹 新增：中分類快速篩選 -->
          <div id="subQuickFilters" class="quick-filters" style="display:none;">
            <div class="quick-filter-label">中分類：</div>
          </div>
        </div>
      </div>

      <div id="errorInfo" class="error" style="display: none;"></div>

      <div class="table-section">
        <div class="table-container">
          <table id="resultTable">
            <thead>
              <tr>
                <th>型號</th>
                <th>Code</th>
                <th>產品名稱</th>
                <th>大分類</th>
                <th>中分類</th>
                <th>小分類</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="loading">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 教育價頁面 -->
    <div id="educationPage" class="page content-page">
      <div class="content-wrapper">
        <h2 class="page-title">教育價格資訊</h2>
        <!-- 你的原始內容保持不變 -->
      </div>
    </div>

    <!-- CARE 保險頁面 -->
    <div id="carePage" class="page content-page">
      <div class="content-wrapper">
        <h2 class="page-title">CARE 保險資訊</h2>
        <!-- 你的原始內容保持不變 -->
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>Created by Morio © 2025</p>
  </footer>

  <script>
    let data = [];
    let originalData = [];
    let columnMapping = {};
    let allCategories = new Set();
    let allSubcategories = new Set();
    let activeQuickFilter = null;

    // ✅ 新增：中分類按鈕區
    const subQuickFilters = document.getElementById('subQuickFilters');

    // 頁面切換功能（不變）
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`${pageName}Page`).classList.add('active');
      document.querySelector(`.nav-btn[onclick="showPage('${pageName}')"]`).classList.add('active');
    }

    // 原本 initializeFilters()、updateSubcategoryOptions()、applyFilters() 等函式保持不變

    // ✅ 修改 quickFilter：支援動態生成中分類按鈕
    function quickFilter(category) {
      const categorySelect = document.getElementById('categoryFilter');
      const subcategorySelect = document.getElementById('subcategoryFilter');
      const buttons = document.querySelectorAll('.quick-filter-btn');

      buttons.forEach(btn => btn.classList.remove('active'));

      // 若重複點擊同一個大分類 => 取消選擇並隱藏中分類
      if (activeQuickFilter === category) {
        activeQuickFilter = null;
        categorySelect.value = '';
        subcategorySelect.value = '';
        subQuickFilters.style.display = 'none';
        updateSubcategoryOptions('');
        applyFilters();
        return;
      }

      // 新選擇的大分類
      activeQuickFilter = category;
      categorySelect.value = category;
      subcategorySelect.value = '';
      event.target.classList.add('active');

      // 找出對應中分類
      const relevantSubcategories = new Set();
      originalData.forEach(row => {
        const cat = row[columnMapping['大分類']];
        const sub = row[columnMapping['中分類']];
        if (cat === category && sub && sub.trim()) {
          relevantSubcategories.add(sub.trim());
        }
      });

      // 生成中分類按鈕
      subQuickFilters.innerHTML = '<div class="quick-filter-label">中分類：</div>';
      Array.from(relevantSubcategories).sort().forEach(sub => {
        const btn = document.createElement('button');
        btn.className = 'quick-filter-btn';
        btn.textContent = sub;
        btn.onclick = () => {
          subcategorySelect.value = sub;
          applyFilters();
          subQuickFilters.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
        subQuickFilters.appendChild(btn);
      });

      subQuickFilters.style.display = 'flex';
      updateSubcategoryOptions(category);
      applyFilters();
    }

    // ✅ 修改：清除篩選時關閉中分類按鈕區
    function clearAllFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('subcategoryFilter').value = '';
      activeQuickFilter = null;
      document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
      subQuickFilters.style.display = 'none';
      updateSubcategoryOptions('');
      renderTable(originalData);
      updateFilterInfo();
    }

    // 其餘 parseCSV、renderTable、loadDefaultCSV 等保持原樣
    // ...
    async function loadDefaultCSV() {
      try {
        const response = await fetch("data.csv");
        const text = await response.text();
        originalData = await parseCSVWithPapa(text);
        const headers = Object.keys(originalData[0]);
        createColumnMapping(headers);
        renderTable(originalData);
        initializeFilters();
      } catch (error) {
        showError('載入資料失敗: ' + error.message);
      }
    }

    loadDefaultCSV();
  </script>
</body>
</html>
